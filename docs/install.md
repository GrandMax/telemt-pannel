# Установка telemt через скрипт (Docker + Traefik)

В корне репозитория один скрипт управления — **`install.sh`**: интерактивное меню (установка, обновление, смена домена SNI, удаление). В начале скрипта задана переменная **`SCRIPT_VERSION`** (семантическая версия); она используется при пункте меню «Обновление» для проверки и замены скрипта на более новую версию из репозитория.

Скрипты разворачивают MTProxy с Fake TLS за Traefik: один порт 443, маршрутизация по SNI. Образ telemt можно **собрать из исходников** (локально) или **скачать готовый** из репозитория `grandmax/telemt`.

## Требования

- Docker и Docker Compose (скрипт при необходимости предложит установить Docker).
- **Готовый образ (prebuilt):** скрипт можно запускать из любого каталога или через `curl ... | bash`; если локальных шаблонов нет — шаблоны скачиваются в каталог, заданный `TEMPLATES_CACHE_DIR`, либо по умолчанию во временный каталог; в интерактивном режиме можно выбрать текущий каталог (./.mtpanel-templates). Установка без root возможна при выборе временного каталога или своего каталога установки.
- **Сборка из исходников (build):** если скрипт запущен не из каталога с репозиторием (нет `install/`, `Dockerfile`), он клонирует [GrandMax/telemt-panel](https://github.com/GrandMax/telemt-panel) в каталог из `CLONE_DIR` или по умолчанию в `<INSTALL_DIR>/.telemt-source`. Для клонирования нужен **git**; при отсутствии скрипт попытается установить его (apt-get/dnf/yum), иначе нужно установить вручную.

Каталоги по умолчанию:

- **Каталог установки**: `/opt/mtpanel-data` (переменная `INSTALL_DIR`)
- **Шаблоны (при скачивании)**: по умолчанию временный каталог; при задании `TEMPLATES_CACHE_DIR` — указанный каталог; в интерактиве можно выбрать текущий каталог (./.mtpanel-templates)
- **Клон исходников (build)**: `<INSTALL_DIR>/.telemt-source` (переопределяется через `CLONE_DIR`)

При установке без root задайте свой каталог установки, например `INSTALL_DIR=$HOME/mtpanel-data`; для шаблонов выберите временный каталог или текущий (./.mtpanel-templates). Клон репозитория при сборке из исходников по умолчанию создаётся внутри каталога установки.

## Установка и управление

Из корня репозитория запустите:

```bash
./install.sh
```

**При запуске без аргументов** (в терминале с TTY) отображается **интерактивное меню**:

1) Установка (новая установка в каталог)  
2) Обновление (пересборка и перезапуск)  
3) Смена домена (SNI)  
4) Удаление  
5) Выход  

Выберите пункт (1–5). Дальше скрипт запросит все нужные параметры диалогами: каталог установки, порт, домен для Fake TLS (SNI), подтверждения. Управление полностью внутри скрипта, без ключей в командной строке.

При выборе **Установка** по шагам запрашиваются: каталог (по умолчанию `/opt/mtpanel-data`), порт (443 или 1443 при занятости), домен маскировки (по умолчанию `1c.ru`), **способ получения образа telemt** (1 — собрать из исходников локально, 2 — скачать готовый образ из `grandmax/telemt:latest`), подтверждение. В конце выводится ссылка `tg://proxy?server=...&port=...&secret=...` — добавьте её в Telegram (Настройки → Данные и память → Использовать прокси).

## Режим без меню (автоматизация)

Для скриптов и CI можно передать действие первым аргументом; параметры задаются переменными окружения (см. ниже):

```bash
./install.sh install             # установка (параметры из env)
./install.sh update              # обновление (INSTALL_DIR из env)
./install.sh config --sni example.com  # смена домена без TTY
./install.sh uninstall -y        # удаление без подтверждения (INSTALL_DIR из env)
```

## Переменные окружения

При запуске без TTY (например из CI или по SSH без интерактива) можно задать параметры через переменные:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `INSTALL_DIR` | Каталог установки | `/opt/mtpanel-data` |
| `LISTEN_PORT` | Порт прокси на хосте | `443` |
| `FAKE_DOMAIN` | Домен для Fake TLS (SNI) | `1c.ru` |
| `FAKE_DOMAIN_FROM_ENV` | То же (приоритет при установке) | — |
| `TELEMT_INTERNAL_PORT` | Внутренний порт telemt в Docker | `1234` |
| `TELEMT_IMAGE_SOURCE` | Источник образа: `build` (сборка из исходников) или `prebuilt` (скачать готовый) | `prebuilt` |
| `TELEMT_PREBUILT_IMAGE` | Имя готового образа при `TELEMT_IMAGE_SOURCE=prebuilt` | `grandmax/telemt:latest` |
| `TEMPLATES_CACHE_DIR` | Каталог для скачанных шаблонов (при отсутствии локальных) | по умолчанию временный каталог; при задании — указанный путь (например `$(pwd)/.mtpanel-templates`) |
| `CLONE_DIR` | Каталог клона репозитория при сборке из исходников | `<INSTALL_DIR>/.telemt-source` |

Пример неинтерактивной установки:

```bash
INSTALL_DIR=/opt/mtpanel FAKE_DOMAIN=sberbank.ru ./install.sh install
```

## Смена домена (SNI)

После установки домен маскировки можно изменить без переустановки:

- **Через меню**: запустите `./install.sh`, выберите «3) Смена домена (SNI)», укажите каталог установки и новый домен (текущий подставляется по умолчанию).
- **Без TTY**: `./install.sh config --sni другой-домен.ru` (каталог из `INSTALL_DIR`).

Обновляются `telemt.toml` (поле `tls_domain`) и правило SNI в `traefik/dynamic/tcp.yml`; контейнеры перезапускаются, выводится новая ссылка для Telegram.

## Сборка и публикация образа (для сопровождающих)

Чтобы собрать образ telemt и опубликовать его в репозиторий `grandmax/telemt` (для установки по варианту «готовый образ»):

1. Выполните вход в реестр: `docker login` (для Docker Hub — учётная запись grandmax).
2. Из корня репозитория запустите:
   ```bash
   DOCKERHUB_USERNAME=grandmax DOCKERHUB_TOKEN=ваш_токен ./scripts/docker-build-push.sh
   ```
   Скрипт соберёт образы из `Dockerfile` и `panel/Dockerfile`, протегирует их как `grandmax/telemt:latest`, `grandmax/telemt-panel:latest` и с тегом версии из `Cargo.toml`, затем отправит в реестр. Подробнее: [docs/builddocker.md](docs/builddocker.md).
3. Только локальная сборка без отправки: выполните `docker build` вручную (см. [docs/builddocker.md](docs/builddocker.md)).

**Сборка в GitHub Actions:** workflow «Docker build and push» запускается только вручную (Actions → Docker build and push → Run workflow). В настройках репозитория (Settings → Secrets and variables → Actions) добавьте секреты: `DOCKERHUB_USERNAME` (логин Docker Hub) и `DOCKERHUB_TOKEN` (Access Token из [Docker Hub → Security](https://hub.docker.com/settings/security)).

## Полезные команды

- Логи: `cd <каталог_установки> && docker compose logs -f`
- Остановка: `cd <каталог_установки> && docker compose down`
- Перезапуск после ручного изменения конфигов: `docker compose up -d --force-recreate`

## Устранение проблем

- **Не подключается к прокси в Telegram** — проверьте, что порт открыт в файрволе и в панели VPS/облака; что в ссылке указан правильный IP сервера (`curl -s ifconfig.me`); что домен в ссылке совпадает с `tls_domain` в `telemt.toml` и с правилом HostSNI в `traefik/dynamic/tcp.yml`.
- **Ошибки при сборке** — убедитесь, что скрипт запущен из корня репозитория и в нём есть каталог `install/` с шаблонами и `Dockerfile`. Меню управления: `./install.sh`.

## Безопасность

- Ссылку прокси не публикуйте.
- Рекомендуется порт 443 и домен маскировки с рабочим HTTPS (например 1c.ru, sberbank.ru).

## Чек-лист тестирования скрипта

Проверки можно выполнять через `./install.sh`.

- [ ] **Меню** — запуск `./install.sh` без аргументов: отображается меню 1–5, выбор пункта ведёт к соответствующим запросам (каталог, порт, домен и т.д.).
- [ ] **Установка** — из меню выбрать 1), ввести каталог/порт/домен, выбрать способ образа (1 — сборка, 2 — готовый). Проверить: создан каталог установки, `docker compose ps` показывает traefik и telemt, выведена ссылка.
- [ ] **Обновление** — из меню выбрать 2), указать каталог установки. Проверить: образ telemt пересобран или обновлён (pull), контейнеры перезапущены. При запуске из корня репозитория с правами на запись скрипт также проверяет наличие более новой версии `install.sh` в репозитории GrandMax/telemt-panel и при наличии заменяет его (сравнение по `SCRIPT_VERSION`).
- [ ] **Смена домена** — из меню выбрать 3), указать каталог и новый домен. Проверить: в `telemt.toml` и `traefik/dynamic/tcp.yml` новый домен, выведена новая ссылка.
- [ ] **Удаление** — из меню выбрать 4), указать каталог и подтвердить. Проверить: контейнеры остановлены, каталог удалён.
- [ ] **Без TTY** — `INSTALL_DIR=... ./install.sh install` и при необходимости другие действия с аргументом. Проверить: выполнение без меню, параметры из env.
