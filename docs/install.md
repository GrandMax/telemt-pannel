# Установка telemt через скрипт (Docker + Traefik)

В корне репозитория есть два скрипта управления:

- **`mtpannel.sh`** — рекомендуемый способ: интерактивное меню с псевдографикой (рамки, разделители, цветные сообщения). Те же действия: установка, обновление, смена домена (SNI), удаление.
- **`install.sh`** — тот же функционал, обратная совместимость; при желании можно вызывать `./install.sh` как раньше.

Скрипты разворачивают MTProxy с Fake TLS за Traefik: один порт 443, маршрутизация по SNI. Образ telemt можно **собрать из исходников** (локально) или **скачать готовый** из репозитория `grandmax/telemt-pannel`.

## Требования

- Docker и Docker Compose
- Запуск скрипта из корня репозитория telemt (нужны шаблоны из каталога `install/`)

## Установка и управление

Из корня репозитория запустите (рекомендуется):

```bash
./mtpannel.sh
```

Или по привычке: `./install.sh` — поведение то же.

**При запуске без аргументов** (в терминале с TTY) отображается **интерактивное меню**:

1) Установка (новая установка в каталог)  
2) Обновление (пересборка и перезапуск)  
3) Смена домена (SNI)  
4) Удаление  
5) Выход  

Выберите пункт (1–5). Дальше скрипт запросит все нужные параметры диалогами: каталог установки, порт, домен для Fake TLS (SNI), подтверждения. Управление полностью внутри скрипта, без ключей в командной строке.

При выборе **Установка** по шагам запрашиваются: каталог (по умолчанию `./mtproxy-data`), порт (443 или 1443 при занятости), домен маскировки (по умолчанию `1c.ru`), **способ получения образа telemt** (1 — собрать из исходников локально, 2 — скачать готовый образ из `grandmax/telemt-pannel:latest`), подтверждение. В конце выводится ссылка `tg://proxy?server=...&port=...&secret=...` — добавьте её в Telegram (Настройки → Данные и память → Использовать прокси).

## Режим без меню (автоматизация)

Для скриптов и CI можно передать действие первым аргументом; параметры задаются переменными окружения (см. ниже):

```bash
./mtpannel.sh install            # установка (параметры из env)
./mtpannel.sh update             # обновление (INSTALL_DIR из env)
./mtpannel.sh config --sni example.com  # смена домена без TTY
./mtpannel.sh uninstall -y       # удаление без подтверждения (INSTALL_DIR из env)
```

То же самое поддерживает `./install.sh`.

## Переменные окружения

При запуске без TTY (например из CI или по SSH без интерактива) можно задать параметры через переменные:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `INSTALL_DIR` | Каталог установки | `$(pwd)/mtproxy-data` |
| `LISTEN_PORT` | Порт прокси на хосте | `443` |
| `FAKE_DOMAIN` | Домен для Fake TLS (SNI) | `1c.ru` |
| `FAKE_DOMAIN_FROM_ENV` | То же (приоритет при установке) | — |
| `TELEMT_INTERNAL_PORT` | Внутренний порт telemt в Docker | `1234` |
| `TELEMT_IMAGE_SOURCE` | Источник образа: `build` (сборка из исходников) или `prebuilt` (скачать готовый) | `build` |
| `TELEMT_PREBUILT_IMAGE` | Имя готового образа при `TELEMT_IMAGE_SOURCE=prebuilt` | `grandmax/telemt-pannel:latest` |

Пример неинтерактивной установки:

```bash
INSTALL_DIR=/opt/mtproxy FAKE_DOMAIN=sberbank.ru ./mtpannel.sh install
```

## Смена домена (SNI)

После установки домен маскировки можно изменить без переустановки:

- **Через меню**: запустите `./mtpannel.sh` (или `./install.sh`), выберите «3) Смена домена (SNI)», укажите каталог установки и новый домен (текущий подставляется по умолчанию).
- **Без TTY**: `./mtpannel.sh config --sni другой-домен.ru` (каталог из `INSTALL_DIR`).

Обновляются `telemt.toml` (поле `tls_domain`) и правило SNI в `traefik/dynamic/tcp.yml`; контейнеры перезапускаются, выводится новая ссылка для Telegram.

## Сборка и публикация образа (для сопровождающих)

Чтобы собрать образ telemt и опубликовать его в репозиторий `grandmax/telemt-pannel` (для установки по варианту «готовый образ»):

1. Выполните вход в реестр: `docker login` (для Docker Hub — учётная запись grandmax).
2. Из корня репозитория запустите:
   ```bash
   ./scripts/build-docker-release.sh
   ```
   Скрипт соберёт образ из `Dockerfile`, протегирует его как `grandmax/telemt-pannel:latest` и `grandmax/telemt-pannel:<версия>` (версия из `Cargo.toml`) и отправит образ в реестр.
3. Только локальная сборка без отправки: `./scripts/build-docker-release.sh --no-push`.

**Сборка в GitHub Actions:** workflow «Docker build and push» запускается только вручную (Actions → Docker build and push → Run workflow). В настройках репозитория (Settings → Secrets and variables → Actions) добавьте секреты: `DOCKERHUB_USERNAME` (логин Docker Hub) и `DOCKERHUB_TOKEN` (Access Token из [Docker Hub → Security](https://hub.docker.com/settings/security)).

## Полезные команды

- Логи: `cd <каталог_установки> && docker compose logs -f`
- Остановка: `cd <каталог_установки> && docker compose down`
- Перезапуск после ручного изменения конфигов: `docker compose up -d --force-recreate`

## Устранение проблем

- **Не подключается к прокси в Telegram** — проверьте, что порт открыт в файрволе и в панели VPS/облака; что в ссылке указан правильный IP сервера (`curl -s ifconfig.me`); что домен в ссылке совпадает с `tls_domain` в `telemt.toml` и с правилом HostSNI в `traefik/dynamic/tcp.yml`.
- **Ошибки при сборке** — убедитесь, что скрипт запущен из корня репозитория и в нём есть каталог `install/` с шаблонами и `Dockerfile`. Меню управления: `./mtpannel.sh` или `./install.sh`.

## Безопасность

- Ссылку прокси не публикуйте.
- Рекомендуется порт 443 и домен маскировки с рабочим HTTPS (например 1c.ru, sberbank.ru).

## Чек-лист тестирования скрипта

Проверки можно выполнять через `./mtpannel.sh` или `./install.sh`.

- [ ] **Меню** — запуск `./mtpannel.sh` без аргументов: отображается меню 1–5 с рамками и цветами, выбор пункта ведёт к соответствующим запросам (каталог, порт, домен и т.д.).
- [ ] **Установка** — из меню выбрать 1), ввести каталог/порт/домен, выбрать способ образа (1 — сборка, 2 — готовый). Проверить: создан каталог установки, `docker compose ps` показывает traefik и telemt, выведена ссылка.
- [ ] **Обновление** — из меню выбрать 2), указать каталог установки. Проверить: образ telemt пересобран или обновлён (pull), контейнеры перезапущены.
- [ ] **Смена домена** — из меню выбрать 3), указать каталог и новый домен. Проверить: в `telemt.toml` и `traefik/dynamic/tcp.yml` новый домен, выведена новая ссылка.
- [ ] **Удаление** — из меню выбрать 4), указать каталог и подтвердить. Проверить: контейнеры остановлены, каталог удалён.
- [ ] **Без TTY** — `INSTALL_DIR=... ./mtpannel.sh install` и при необходимости другие действия с аргументом. Проверить: выполнение без меню, параметры из env.
