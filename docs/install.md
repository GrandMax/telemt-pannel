# Установка telemt через скрипт (Docker + Traefik)

Скрипт `install.sh` в корне репозитория разворачивает MTProxy с Fake TLS за Traefik: один порт 443, маршрутизация по SNI, сборка telemt из исходников в Docker.

## Требования

- Docker и Docker Compose
- Запуск скрипта из корня репозитория telemt (нужны шаблоны из каталога `install/`)

## Установка

Из корня репозитория:

```bash
./install.sh
```

Скрипт интерактивно запросит:

1. **Каталог установки** — куда положить `docker-compose.yml`, `telemt.toml`, конфиги Traefik (по умолчанию `./mtproxy-data`).
2. **Порт** — на каком порту слушать прокси (по умолчанию 443; если занят, предложит 1443).
3. **Домен для маскировки (SNI)** — домен Fake TLS, под который маскируется трафик (по умолчанию `1c.ru`).
4. Подтверждение параметров и запуск сборки и контейнеров.

В конце будет выведена ссылка вида `tg://proxy?server=...&port=...&secret=...` — добавьте её в Telegram (Настройки → Данные и память → Использовать прокси).

## Подкоманды

| Подкоманда   | Описание |
|-------------|----------|
| `install`   | Установка (по умолчанию при запуске без аргументов). |
| `update`    | Обновить образ telemt из текущего состояния репо и перезапустить контейнеры. Перед этим при необходимости выполните `git pull`. |
| `config`    | Сменить домен Fake TLS (SNI) без переустановки. Обновляет `telemt.toml` и конфиг Traefik, перезапускает сервисы и выводит новую ссылку. |
| `uninstall` | Остановить контейнеры и удалить каталог установки. |

Примеры:

```bash
./install.sh                    # интерактивная установка
./install.sh update             # обновление (в каталоге по умолчанию)
./install.sh update /opt/mtproxy # обновление в указанном каталоге
./install.sh config             # интерактивная смена домена SNI
./install.sh config --sni example.com  # сменить домен на example.com
./install.sh uninstall          # удаление (запросит подтверждение)
./install.sh uninstall -y       # удаление без подтверждения
./install.sh uninstall -y /path/to/mtproxy-data  # удалить указанную установку
```

## Переменные окружения

При запуске без TTY (например из CI или по SSH без интерактива) можно задать параметры через переменные:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `INSTALL_DIR` | Каталог установки | `$(pwd)/mtproxy-data` |
| `LISTEN_PORT` | Порт прокси на хосте | `443` |
| `FAKE_DOMAIN` | Домен для Fake TLS (SNI) | `1c.ru` |
| `FAKE_DOMAIN_FROM_ENV` | То же (приоритет при установке) | — |
| `TELEMT_INTERNAL_PORT` | Внутренний порт telemt в Docker | `1234` |

Пример неинтерактивной установки:

```bash
INSTALL_DIR=/opt/mtproxy FAKE_DOMAIN=sberbank.ru ./install.sh
```

## Смена домена (SNI)

После установки домен маскировки можно изменить без переустановки:

- Интерактивно: `./install.sh config` — скрипт запросит новый домен (по умолчанию подставит текущий).
- С параметром: `./install.sh config --sni другой-домен.ru`.

Обновляются `telemt.toml` (поле `tls_domain`) и правило SNI в `traefik/dynamic/tcp.yml`; контейнеры перезапускаются, выводится новая ссылка для Telegram.

## Полезные команды

- Логи: `cd <каталог_установки> && docker compose logs -f`
- Остановка: `cd <каталог_установки> && docker compose down`
- Перезапуск после ручного изменения конфигов: `docker compose up -d --force-recreate`

## Устранение проблем

- **Не подключается к прокси в Telegram** — проверьте, что порт открыт в файрволе и в панели VPS/облака; что в ссылке указан правильный IP сервера (`curl -s ifconfig.me`); что домен в ссылке совпадает с `tls_domain` в `telemt.toml` и с правилом HostSNI в `traefik/dynamic/tcp.yml`.
- **Ошибки при сборке** — убедитесь, что скрипт запущен из корня репозитория и в нём есть каталог `install/` с шаблонами и `Dockerfile`.

## Безопасность

- Ссылку прокси не публикуйте.
- Рекомендуется порт 443 и домен маскировки с рабочим HTTPS (например 1c.ru, sberbank.ru).

## Чек-лист тестирования скрипта

- [ ] **install** — запуск `./install.sh` из корня репо (интерактивно или с env `INSTALL_DIR`, `LISTEN_PORT`, `FAKE_DOMAIN`). Проверить: создан каталог установки, `docker compose ps` показывает traefik и telemt, выведена ссылка.
- [ ] **update** — в каталоге установки выполнить `../install.sh update` или `./install.sh update /path/to/install`. Проверить: образ telemt пересобран, контейнеры перезапущены.
- [ ] **config** — выполнить `./install.sh config --sni другой-домен.ru` или интерактивно `./install.sh config`. Проверить: в `telemt.toml` и `traefik/dynamic/tcp.yml` новый домен, выведена новая ссылка.
- [ ] **uninstall** — выполнить `./install.sh uninstall -y` (или с путём). Проверить: контейнеры остановлены, каталог удалён.
